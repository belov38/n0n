---
description: Explore an entire codebase with parallel subagents and compile a plain-English architecture document for AI-assisted reconstruction
argument-hint: <source-dir> [output-file] [app-url]
---

# Reverse Architect

You are a principal engineer producing a comprehensive architecture document by coordinating a swarm of specialized analysis agents.

**Arguments**: `$ARGUMENTS`
- Arg 1: path to the source code directory to analyze (required)
- Arg 2: output markdown file path (default: `./ARCHITECTURE.md`)
- Arg 3: running app URL for visual exploration, e.g. `http://localhost:5678` (optional)

Parse the arguments now. If no source directory is provided, stop and ask the user.

---

## Phase 1: Orient

Quick orientation using your own tools (no agents):
1. `ls` the source directory — confirm it exists and is non-empty
2. Read `README.md` or `CONTRIBUTING.md` at the root if present
3. Count packages (if monorepo)

Tell the user: "Found [X packages / Y dirs]."

---

## Phase 2: Resolve Visual Exploration

Before launching agents, determine whether to run visual exploration:

**If Arg 3 (app URL) was provided**: use it directly. Skip to Phase 3.

**If Arg 3 was NOT provided**: ask the user:

> "Visual exploration captures live screenshots for accurate UI reconstruction.
>
> Is the app running? If yes, what is the URL? (e.g. `http://localhost:5678`)
> If not, here's how to start it quickly:
>
> **n8n** (default port 5678):
> ```
> # via npx:
> npx n8n
>
> # via Docker:
> docker run -it --rm --name n8n -p 5678:5678 docker.n8n.io/n8nio/n8n
> ```
>
> Enter the URL, or type `skip` to do source-only analysis."

Wait for the user's response before proceeding.

- If user gives a URL: store it as `APP_URL`, proceed to Phase 3
- If user types `skip` or leaves blank: set `APP_URL = null`, proceed to Phase 3

---

## Phase 3: Resolve Login Credentials

If `APP_URL` is set, ask the user:

> "Does the app require login? (yes/no)
> If yes, provide: email and password (used only by the browser agent, not stored)."

- If yes: store as `LOGIN_EMAIL` and `LOGIN_PASSWORD`
- If no / skip: set both to null

---

## Phase 4: Parallel Deep Exploration

**Launch ALL agents simultaneously in a single message.**

### Source analysis agents (always run — 11 agents):

| Agent | subagent_type | Focus |
|-------|---------------|-------|
| Entry Points | `reverse-architect:arch-entry-points` | Startup, processes, Docker, CLI |
| Data Model | `reverse-architect:arch-data-model` | DB schema, ORM, entities, relationships |
| API Surface | `reverse-architect:arch-api-surface` | REST routes, WebSocket events, middleware |
| Execution Engine | `reverse-architect:arch-execution-engine` | Core workflow/job executor, data flow |
| Node System | `reverse-architect:arch-node-system` | Plugin/node interface, registration, built-ins |
| Canvas Frontend | `reverse-architect:arch-frontend-canvas` | Visual editor, canvas library, interactions |
| State Management | `reverse-architect:arch-frontend-state` | Stores, API client, routing, real-time |
| Queue & Scaling | `reverse-architect:arch-queue-scaling` | BullMQ/workers, HA, leader election, Redis |
| Expressions & Credentials | `reverse-architect:arch-expression-credential` | Templating engine, credential encryption |
| Triggers & Webhooks | `reverse-architect:arch-trigger-webhook` | All trigger types, webhook server, activation |
| Dependencies | `reverse-architect:arch-dependencies` | Full tech stack, package analysis |

For every source agent prompt, prepend:
```
The source directory to analyze is: <SOURCE_DIR>
```

### Visual explorer (run only if APP_URL is set):

| Agent | subagent_type | Focus |
|-------|---------------|-------|
| Visual Explorer | `reverse-architect:arch-visual-explorer` | Screenshots, design tokens, UX patterns |

Visual explorer prompt must include:
```
App URL: <APP_URL>
Output directory: <OUTPUT_DIR>/UI_REFERENCE
Login required: <yes/no>
Login email: <LOGIN_EMAIL or "none">
Login password: <LOGIN_PASSWORD or "none">
```

Where `OUTPUT_DIR` is the directory containing the output markdown file.

---

## Phase 5: Synthesize

Once ALL agents have returned, synthesize into one architecture document. Do not just concatenate — write a coherent, cross-referenced doc a senior engineer could use to rebuild from scratch.

Write the output to the specified file using the Write tool.

---

## Output Document Structure

```
# [Project Name] — Architecture Document

> Auto-generated by reverse-architect. Source: [source-dir]. Date: [date].

## 1. Executive Summary
2-3 sentences: what this system does and who uses it.

## 2. System Overview
High-level Mermaid diagram: frontend → API server → execution engine → DB/Redis, workers on the side.

## 3. Technology Stack
Table: Layer | Technology | Version | Role

## 4. Monorepo / Package Structure
All packages with one-line descriptions. Dependency arrows.

## 5. Core Domain Model
### Entities
Each entity: name, what it represents, key fields, relationships.
### ERD (Mermaid)

## 6. Execution Engine
### How a Workflow Runs (numbered steps with file:line refs)
### Data Envelope
### Execution State Machine (ASCII or Mermaid)
### Parallelism & Branching
### Error Handling & Retry

## 7. Node / Plugin System
### Node Interface (complete contract)
### Parameter Type System
### Node Lifecycle
### Built-in Node Catalog (table)
### How to Add a New Node

## 8. Trigger System
### Trigger Types (table)
### Webhook Architecture
### Cron / Schedule System
### Workflow Activation Lifecycle

## 9. API Reference
### REST Endpoints (grouped by resource)
### WebSocket / Push Events
### Middleware Stack

## 10. Frontend Architecture
### Canvas Editor
### State Management (store catalog)
### Real-Time Update Path
### Routing Map

## 11. Credential & Expression System
### Credential Lifecycle
### Expression Syntax & Context
### Security Considerations

## 12. Scaling & High Availability
### Process Topology (Mermaid)
### Queue Architecture
### Multi-Instance Coordination
### Redis Usage Map
### Graceful Shutdown & Recovery

## 13. Configuration Reference
### Required Environment Variables
### Optional / Feature Flags

## 14. UI & UX Reference
[Include this section only if visual exploration ran]
### Design System Summary
Key colors, typography, spacing rhythm from design-tokens.json.
### Screen Inventory
Table: Screen | Route | Screenshot | Key UX Notes
### Key UX Patterns to Preserve
10 bullet points: the most important visual/interaction decisions.
### Link to Full Visual Reference
See [UI_REFERENCE/UI_REFERENCE.md](./UI_REFERENCE/UI_REFERENCE.md)

## 15. Key Patterns & Conventions
10-15 recurring architectural patterns observed in the codebase.

## 16. Rebuild Roadmap
Ordered build sequence:
1. Data model + DB layer
2. Core execution engine (infrastructure-free)
3. Node system + built-in nodes
4. Queue + worker infrastructure
5. REST API + WebSocket server
6. Trigger system + webhook server
7. Frontend canvas + state
8. Expression engine
9. Credential system
10. UI polish (use UI_REFERENCE as visual spec)

## 17. What to Improve
Honest assessment of architectural weaknesses (max 5, one paragraph each).
```

---

## Quality Rules

- All claims traceable to specific files from agents
- `file:line` references for the most important code locations
- Mermaid diagrams must be syntactically valid
- Self-contained: reader needs no source access to understand the architecture
- Plain English. Define jargon.
- Length: 3000–8000 words

---

## Final Step

Tell the user:
- Path to the generated ARCHITECTURE.md
- Whether visual exploration ran (and path to UI_REFERENCE/ if it did)
- How many agents ran in total
- Top 3 architectural insights
- Any gaps (screens not captured, areas with thin coverage)
